graph TB
    subgraph "User Layer"
        Player[üë§ Player]
    end

    subgraph "Godot Game Engine"
        subgraph "UI Layer"
            DialogueUI[üé® Dialogue UI<br/>dialogue_ui.gd]
        end
        
        subgraph "Core Systems"
            GameManager[üéÆ Game Manager<br/>game_manager.gd<br/><br/>‚Ä¢ Story progression<br/>‚Ä¢ State management<br/>‚Ä¢ Skill checks<br/>‚Ä¢ Save/Load]
        end
        
        subgraph "Import System"
            StoryImporter[üì• Story Importer<br/>story_importer.gd<br/><br/>‚Ä¢ Parse JSON<br/>‚Ä¢ Convert nodes<br/>‚Ä¢ Apply effects<br/>‚Ä¢ Check conditions]
        end
        
        subgraph "AI Integration"
            AIClient[ü§ñ AI Client<br/>ai_client.gd<br/><br/>‚Ä¢ HTTP requests<br/>‚Ä¢ Text generation<br/>‚Ä¢ Image generation<br/>‚Ä¢ Asset caching]
        end
        
        subgraph "Media System"
            MediaManager[üé¨ Media Manager<br/>media_manager.gd<br/><br/>‚Ä¢ Portrait loading<br/>‚Ä¢ Background loading<br/>‚Ä¢ Music playback<br/>‚Ä¢ Sound effects]
        end
    end

    subgraph "Local Storage"
        DemoJSON[üìÑ stories/demo.json<br/><br/>StoryBlocks JSON:<br/>‚Ä¢ Nodes<br/>‚Ä¢ Choices<br/>‚Ä¢ Conditions<br/>‚Ä¢ Effects]
        
        Assets[üñºÔ∏è assets/<br/><br/>‚Ä¢ portraits/<br/>‚Ä¢ backgrounds/<br/>‚Ä¢ audio/music/<br/>‚Ä¢ audio/sfx/]
    end

    subgraph "External Services"
        FlaskProxy[üåê Flask API Proxy<br/>api_proxy.py<br/><br/>localhost:5000]
        
        xAI[‚òÅÔ∏è xAI API<br/><br/>Grok-3 text<br/>Grok-2-image]
    end

    %% User interactions
    Player -->|Clicks choices| DialogueUI
    DialogueUI -->|Displays story| Player

    %% UI to Core
    DialogueUI -->|Load story| GameManager
    DialogueUI -->|Select choice| GameManager
    DialogueUI -->|Request assets| MediaManager

    %% Core to Import
    GameManager -->|Import story| StoryImporter
    StoryImporter -->|Read JSON| DemoJSON
    StoryImporter -->|Return converted| GameManager

    %% Core to AI
    GameManager -->|Enhance text| AIClient
    AIClient -->|Generated text| GameManager

    %% Media to AI
    MediaManager -->|Generate portrait| AIClient
    MediaManager -->|Generate background| AIClient
    AIClient -->|Image URL/path| MediaManager

    %% Media to Assets
    MediaManager -->|Load files| Assets
    Assets -->|Textures/Audio| MediaManager
    MediaManager -->|Display/Play| DialogueUI

    %% AI to Flask
    AIClient -->|HTTP POST| FlaskProxy
    FlaskProxy -->|API call| xAI
    xAI -->|Response| FlaskProxy
    FlaskProxy -->|JSON response| AIClient

    %% Styling
    classDef uiClass fill:#4A90E2,stroke:#2E5C8A,stroke-width:2px,color:#fff
    classDef coreClass fill:#7B68EE,stroke:#5A4FCF,stroke-width:2px,color:#fff
    classDef importClass fill:#50C878,stroke:#3AA05E,stroke-width:2px,color:#fff
    classDef aiClass fill:#FF6B6B,stroke:#E85555,stroke-width:2px,color:#fff
    classDef mediaClass fill:#FFA500,stroke:#E69500,stroke-width:2px,color:#fff
    classDef storageClass fill:#95A5A6,stroke:#7F8C8D,stroke-width:2px,color:#fff
    classDef externalClass fill:#E74C3C,stroke:#C0392B,stroke-width:2px,color:#fff
    classDef playerClass fill:#2ECC71,stroke:#27AE60,stroke-width:3px,color:#fff

    class DialogueUI uiClass
    class GameManager coreClass
    class StoryImporter importClass
    class AIClient aiClass
    class MediaManager mediaClass
    class DemoJSON,Assets storageClass
    class FlaskProxy,xAI externalClass
    class Player playerClass
